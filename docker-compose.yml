# ContextEngine â€” Base Compose
# Works standalone or with docker-compose.override.yml for production settings.
# For standalone deployment, use docker-compose.product.yml instead.

services:
  context-engine:
    build: .
    container_name: context-engine
    ports:
      - "9040:9040"
    environment:
      - PORT=9040
      - CHROMADB_HOST=context-engine-chromadb
      - CHROMADB_PORT=8000
      - KB_ROOT=/data/kb
      - SESSIONS_DIR=/app/data/sessions
      - LOGS_DIR=/app/data/logs
      - PROMPTS_DIR=/app/data/prompts
      - LEARNING_MODE=false
      - TRANSCRIPTS_DIR=/app/data/transcripts
      - LLM_BASE_URL=${LLM_BASE_URL:-https://openrouter.ai/api/v1}
      - LLM_MODEL_FAST=${LLM_MODEL_FAST:-anthropic/claude-haiku-4.5}
      - LLM_MODEL_SMART=${LLM_MODEL_SMART:-anthropic/claude-sonnet-4.5}
      - WATCH_GIT_ROOT=/watch
    volumes:
      - ce-data:/app/data
    networks:
      - ce-network
    depends_on:
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9040/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  chromadb:
    image: chromadb/chroma:0.5.23
    container_name: context-engine-chromadb
    volumes:
      - chromadb-data:/chroma/chroma
    networks:
      - ce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  ce-data:
  chromadb-data:

networks:
  ce-network:
    driver: bridge
